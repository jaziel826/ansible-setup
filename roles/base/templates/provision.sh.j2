#!/bin/bash
set -euo pipefail

ANSIBLEUSER="velociraptor"
BRANCH="{{ branch | default('master') }}"
LOGFILE="/var/log/ansible.log"
REPO="https://github.com/jaziel826/ansible-setup"
VAULT_KEY="/.vault_key.txt"
PRECMD="sudo systemd-inhibit --who='ansible-pull' --why='provisioning'"
WORKDIR="/home/$ANSIBLEUSER/.ansible"

log() {
    printf "\n%s %s\n" "$(date +"%Y-%m-%d %H:%M:%S")" "$1" | tee -a "$LOGFILE"
}

if pgrep -f ansible-pull > /dev/null; then
    log "A running ansible-pull process was found. Exiting."
    exit 1
fi

log "Starting ansible-pull bootstrap"

sudo -u "$ANSIBLEUSER" mkdir -p "$WORKDIR"

log "Cloning/updating repository"
sudo -iH -u "$ANSIBLEUSER" git clone -b "$BRANCH" "$REPO" "$WORKDIR" 2>/dev/null || \
sudo -iH -u "$ANSIBLEUSER" git -C "$WORKDIR" pull

if [ -f "$WORKDIR/collections/requirements.yml" ]; then
    log "Installing Ansible collections"
    sudo -iH -u "$ANSIBLEUSER" ansible-galaxy collection install \
        -r "$WORKDIR/collections/requirements.yml" --force
fi

log "Running ansible-pull"

if [ -n "${1:-}" ]; then
    $PRECMD sudo -iH -u "$ANSIBLEUSER" ansible-pull \
        --vault-password-file="$VAULT_KEY" \
        -U "$REPO" \
        -C "$BRANCH" \
        --tags "$1" 2>&1 | tee -a "$LOGFILE"
else
    $PRECMD sudo -iH -u "$ANSIBLEUSER" ansible-pull \
        --vault-password-file="$VAULT_KEY" \
        -o \
        -U "$REPO" \
        -C "$BRANCH" 2>&1 | tee -a "$LOGFILE"
fi

log "ansible-pull completed"
